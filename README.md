# Excel File Batch Processor

一个命令行批处理工具，用于自动化处理Excel文件（.xls和.xlsx格式），将工资数据加载到SQLite数据库。

## 功能特性

- 📊 **批量处理**: 自动扫描并处理`new_payroll`和`old_payroll`文件夹中的所有Excel文件
- 🔄 **智能分割**: 自动识别工作表内的多个数据区域并分割为独立表格
- 📋 **数据验证**: 自动验证列结构并应用特殊逻辑处理
- ⚡ **高效处理**: 支持.xls和.xlsx两种格式的Excel文件
- 💾 **数据库集成**: 自动将处理后的数据加载到SQLite数据库
- 🔍 **数据质量分析**: 提供全面的数据质量评估和可视化分析
- 🌐 **Web查看器**: 基于Flask的Web界面用于文件比较和数据查看

## 安装要求

### 系统要求
- Python 3.7+
- Windows/Linux/macOS

### Python依赖包

```bash
pip install openpyxl xlrd pandas numpy flask matplotlib seaborn scipy
```

## 项目结构

```
payroll_excel_processing/
├── batch_process.py              # 主批处理程序
├── check_payroll_database.py     # 数据库检查工具
├── check_load_log_table.py       # 加载日志检查工具
├── data_overview_analysis.py     # 综合数据分析工具
├── update_database_schema.py     # 数据库架构更新工具
├── README.md                     # 说明文档
├── DAILY_LOG.md                  # 开发日志
├── .gitignore                    # Git忽略规则文件
├── new_payroll/                  # 新工资表文件夹（被.gitignore排除）
│   ├── 202501.xls
│   ├── 202502.xls
│   └── ...
├── old_payroll/                  # 旧工资表文件夹（被.gitignore排除）
│   ├── 202001.xls
│   ├── 202002.xls
│   └── ...
├── data_analysis_charts/         # 数据分析图表输出目录
├── relationship_analysis_charts/ # 金额关系分析图表目录
├── one_time_pgms/                # 一次性处理程序和工具
│   ├── excel_viewer.py           # Web-based Excel文件查看器
│   ├── amount_relationship_analysis.py # 金额关系分析工具
│   ├── process_single_file.py    # 单文件处理工具
│   ├── debug_file_matching.py    # 文件匹配调试工具
│   ├── rename_and_move_files.py  # 文件重命名和移动工具
│   └── templates/                # Web界面模板
│       └── index.html            # 主界面模板
└── excel_processor/              # 核心处理模块
    ├── config.py                 # 全局配置和日志设置
    ├── sheet_gen.py              # Excel文件生成器
    ├── sheet_processor.py        # 工作表处理器
    ├── df_gen.py                 # 数据框生成器
    └── special_logic.py          # 特殊逻辑处理
```

## 核心程序说明

### 主要程序

#### batch_process.py
**功能**: 主批处理程序，自动化处理所有Excel文件
- 支持批量处理模式和单文件处理模式
- 完整的端到端数据处理管道
- 自动数据库清理和状态管理
- 详细的处理日志和进度跟踪

#### check_payroll_database.py
**功能**: 数据库检查工具，提供交互式查询功能
- 显示表结构和基本统计信息
- 支持按职员、日期、型号等条件查询
- 提供数据质量评估和异常检测
- 交互式菜单系统

#### check_load_log_table.py
**功能**: 加载日志检查工具
- 显示被丢弃列的信息
- 分析数据处理过程中的问题
- 提供数据质量监控

#### data_overview_analysis.py
**功能**: 综合数据分析工具
- 全面的数据质量评估
- 分布分析和异常检测
- 时间趋势分析
- 自动生成可视化图表

#### update_database_schema.py
**功能**: 数据库架构更新工具
- 将FLOAT字段转换为NUMERIC(10,2)确保精度
- 数据迁移和完整性验证

### 核心处理模块 (excel_processor/)

#### config.py
**功能**: 全局配置管理
- 数据库路径配置
- 期望列定义
- 全局日志设置
- 共享常量定义

#### sheet_gen.py
**功能**: Excel文件生成器
- 扫描和读取Excel文件
- 工作表内容生成
- 文件路径管理
- 工作表过滤逻辑

#### sheet_processor.py
**功能**: 工作表处理器
- 工作表数据处理
- 数据框分割和验证
- 数据库加载功能
- 列验证和智能表头检测

#### df_gen.py
**功能**: 数据框生成器
- 数据框生成和分割
- 表格分割逻辑
- 数据框验证和过滤

#### special_logic.py
**功能**: 特殊逻辑处理
- 18种特殊逻辑规则处理列名不一致问题
- 工作表名称标准化映射
- 数据格式转换和验证
- 详细的日志记录

### 一次性处理程序 (one_time_pgms/)

#### excel_viewer.py
**功能**: Web-based Excel文件查看器
- 基于Flask的Web界面
- 并排比较old_folder和new_folder文件
- 智能工作表名称匹配
- 响应式设计

#### amount_relationship_analysis.py
**功能**: 金额关系分析工具
- 分析计件数量、系数、定额与金额之间的关系
- 相关性分析和公式验证
- 异常模式检测
- 生成关系可视化图表

#### 其他工具程序
- `process_single_file.py`: 单文件处理工具
- `debug_file_matching.py`: 文件匹配调试工具
- `rename_and_move_files.py`: 文件重命名和移动工具
- `precise_header_extractor.py`: 精确表头提取工具

## 使用方法

### 批处理模式（推荐）

#### 1. 处理所有Excel文件

```bash
python batch_process.py
```

此命令将自动处理 `new_payroll` 和 `old_payroll` 文件夹中的所有Excel文件，并将数据加载到SQLite数据库。

#### 2. 处理单个Excel文件

```bash
python batch_process.py 201406.xls
```

此命令仅处理指定的Excel文件，适用于调试或特定文件处理。

#### 3. 数据库检查工具

```bash
# 检查工资数据表
python check_payroll_database.py

# 检查加载日志表
python check_load_log_table.py

# 综合数据分析
python data_overview_analysis.py

# 金额关系分析
python one_time_pgms/amount_relationship_analysis.py
```

#### 4. Web文件查看器

```bash
# 启动Web服务器
python one_time_pgms/excel_viewer.py

# 或使用Windows批处理脚本
one_time_pgms/run_excel_viewer.bat
```

访问 `http://localhost:5000` 查看Web界面。

### 处理流程

批处理程序自动执行以下步骤：
1. **扫描文件**: 自动扫描 `new_payroll` 和 `old_payroll` 文件夹中的所有Excel文件
2. **处理工作表**: 使用智能算法分割工作表为多个数据表格
3. **数据验证**: 自动验证列结构并应用特殊逻辑处理
4. **数据库加载**: 将处理后的数据加载到SQLite数据库
5. **日志记录**: 所有处理过程记录到 `log_batch.txt` 文件

### 输出文件

- **payroll_database.db**: SQLite数据库文件，包含处理后的工资数据
- **log_batch.txt**: 处理日志文件，记录详细的处理过程
- **special_logic_applied.log**: 特殊逻辑应用日志文件（汇总格式）
- **data_analysis_charts/**: 数据分析图表目录
- **relationship_analysis_charts/**: 金额关系分析图表目录

## 特殊逻辑处理规则

系统实现了18种特殊逻辑规则，用于自动处理Excel文件中的列名不一致问题：

### 当前特殊逻辑规则列表：

1. **逻辑1**: "喷漆装配"工作表中，将"前装"/"中装"/"后装"/"刘雷"/"装配"替换为"职员全名"
2. **逻辑2**: "喷漆装配"工作表中，将"后装曾大军"替换为"职员全名"并设置所有值为"曾大军"
3. **逻辑3**: 任意工作表中，将"姓名"替换为"职员全名"
4. **逻辑4**: "绕嵌排"工作表中，将"型号"列后的"嵌线"/"排线"替换为"工序全名"
5. **逻辑5**: "绕嵌排"工作表中，将"型号"列后的"工序名称"替换为"工序全名"
6. **逻辑6**: 如果存在列名为'数量'且同时存在列名为'职工全名'，则将'数量'改为'计件数量'
7. **逻辑7**: 如果存在列名为'加工型号'，则将'加工型号'改为'型号'
8. **逻辑8**: 当'计件数量'包含在列名中时，将该列替换为'计件数量'
9. **逻辑9**: 将'单位工资'替换为'定额'
10. **逻辑10**: 将'合计金额'替换为'金额'
11. **逻辑11**: 将'规格'替换为'型号'
12. **逻辑12**: 当'定额'列后存在'合计'列时，将'合计'替换为'金额'
13. **逻辑13**: 将'任务名称'替换为'客户名称'
14. **逻辑14**: 当'职员全名'是'前装'或'前装人员'时，将记录拆分为2行（黄志梅和陈会清）
15. **逻辑15**: 当'职员全名'是'中装'或'中装人员'时，将值改为'李兆军'
16. **逻辑16**: 当'职员全名'是'后装'或'后装人员'时，将值改为'汤雅林'
17. **逻辑17**: 当'职员全名'列的值为空、空格（或中文空格）、或None时，从数据框中丢弃该行
18. **逻辑18**: 当'职员全名'列包含特定中文短语时，丢弃对应的行（短语：['下料', '铣底脚：', '铣：', '校平衡', '车转子', '压：', '磨：']）

**特殊逻辑总数**: 系统现在包含 **18个特殊逻辑规则**

### 日志记录
所有特殊逻辑应用都会记录到 `special_logic_applied.log` 文件，包含时间戳、文件名、工作表名、表索引和逻辑描述。

## SQLite数据库说明

### 数据库结构

应用程序使用SQLite数据库进行数据持久化存储，包含以下两个主要表：

#### 1. `payroll_details` 表 - 工资数据存储
存储从Excel文件加载的所有工资记录，包含完整的源数据跟踪信息。

**表结构：**
```sql
CREATE TABLE payroll_details (
    文件名 CHAR(100),        -- 源Excel文件名
    sheet名 CHAR(100),       -- 源工作表名
    职员全名 CHAR(20),       -- 员工姓名
    日期 CHAR(20),          -- 工作日期
    客户名称 CHAR(60),       -- 客户名称
    型号 CHAR(100),         -- 产品型号
    工序全名 CHAR(100),     -- 完整工序名称
    工序 CHAR(100),         -- 工序简称
    计件数量 NUMERIC(10,2), -- 计件数量（浮点数，2位小数）
    系数 NUMERIC(10,2),     -- 系数（浮点数，2位小数）
    定额 NUMERIC(10,2),     -- 定额（浮点数，2位小数）
    金额 NUMERIC(10,2),     -- 金额（浮点数，2位小数）
    备注 CHAR(100),         -- 备注信息
    代码 CHAR(12)           -- 代码（外键，引用quota表）
);
```

**数据跟踪功能：**
- 每条记录都包含源文件和工作表信息
- 支持完整的数据溯源和审计
- 便于识别数据来源和处理历史

#### 2. `load_log` 表 - 数据处理日志
记录数据处理过程中被丢弃的列信息，用于数据质量监控和问题排查。

**表结构：**
```sql
CREATE TABLE load_log (
    file_name CHAR(50),         -- 文件名
    sheet_name CHAR(50),        -- 工作表名
    table_index INT,            -- 表格索引（1=表一，2=表二，...）
    discarded_columns CHAR(200), -- 被丢弃的列名（逗号分隔）
    discarded_cols_num INT      -- 被丢弃列的数量
);
```

**日志功能：**
- 记录不符合预期列结构的列名
- 帮助识别数据格式问题
- 支持数据质量分析和改进

### 数据库操作

#### 数据加载
- 使用 `load_df_to_db()` 函数将DataFrame数据加载到数据库
- 自动过滤不符合预期列结构的列
- 自动添加源文件和工作表信息
- 支持批量数据插入

#### 数据查询
可以通过SQLite命令行工具查询数据库内容：

```bash
# 查看表结构
sqlite3 payroll_database.db ".schema"

# 查询工资记录
sqlite3 payroll_database.db "SELECT * FROM payroll_details LIMIT 10;"

# 查询加载日志
sqlite3 payroll_database.db "SELECT * FROM load_log;"

# 统计记录数量
sqlite3 payroll_database.db "SELECT COUNT(*) FROM payroll_details;"
```

### 数据库文件管理

- **文件位置**: `../payroll_database.db`（父目录）
- **自动创建**: 应用程序首次运行时自动创建数据库和表
- **数据持久化**: 所有处理的数据都会持久化保存
- **备份建议**: 定期备份数据库文件

## 数据分析功能

### 数据概览分析
`data_overview_analysis.py` 提供全面的数据分析功能：
- 数据质量评估和完整性检查
- 分布分析和异常检测
- 时间趋势分析
- 自动生成可视化图表

### 金额关系分析
`amount_relationship_analysis.py` 专门分析金额计算模式：
- 计件数量、系数、定额与金额的关系分析
- 相关性分析和公式验证
- 异常模式检测
- 生成关系可视化图表

## 故障排除

### 常见问题

1. **依赖包安装失败**
   ```bash
   # 如果遇到numpy版本冲突
   pip uninstall numpy -y
   pip install numpy==1.24.3
   ```

2. **文件无法读取**
   - 确保Excel文件没有损坏
   - 检查文件权限
   - 确认文件格式支持（.xls或.xlsx）

3. **批处理程序启动失败**
   - 检查Python版本（需要3.7+）
   - 确认所有依赖包已正确安装
   - 检查文件路径和权限设置

### 错误处理
- 文件读取错误时会显示错误信息
- 处理失败的文件状态会重置为"待处理"
- 应用程序会继续处理下一个文件

## 技术架构

### 模块调用关系图

```
batch_process.py (主批处理程序)
    ↓
excel_processor/ (核心处理模块)
    ├── config.py (全局配置和日志设置)
    ├── sheet_gen.py (Excel文件生成器)
    ├── sheet_processor.py (工作表处理器)
    ├── df_gen.py (数据框生成器)
    └── special_logic.py (特殊逻辑处理)
```

### 详细调用栈

#### 1. batch_process.py 调用流程
```python
batch_process_main()
    ↓
get_excel_files()  # 从 sheet_gen.py 获取文件列表
    ↓
sheet_gen()  # 从 sheet_gen.py 生成工作表内容
    ↓
df_gen()  # 从 df_gen.py 生成分割数据框
    ↓
load_df_to_db()  # 从 sheet_processor.py 加载数据到数据库
```

#### 2. 模块间数据流
```
Excel文件 → sheet_gen() → SheetContents → df_gen() → SplitDataFrame → load_df_to_db() → SQLite数据库
```

#### 3. 全局日志配置
- **位置**: `excel_processor/config.py` 中的 `setup_global_logging()` 函数
- **功能**: 统一配置所有模块的日志输出
- **输出**: 所有日志写入 `log_batch.txt` 文件
- **格式**: `%(asctime)s - %(name)s - %(levelname)s - %(message)s`
- **级别**: INFO 级别，包含控制台和文件输出

## 近期更新

### 2025年11月27日更新

#### 1. 型号列数据格式修复
- **问题**: "型号"列中的数值（如132, 71, 90）被读取为带小数点的格式（132.0, 71.0, 90.0）
- **解决方案**: 修改Excel读取逻辑，确保型号列作为字符串读取，移除整数数值的'.0'后缀
- **结果**: 型号列正确显示为 "132", "71", "90" 而不是 "132.0", "71.0", "90.0"

#### 2. 代码重构优化
- **问题**: `.xlsx` 和 `.xls` 文件处理逻辑重复，代码冗余
- **解决方案**: 提取公共逻辑到 `_process_cell_value()` 辅助函数
- **结果**: 代码更简洁、更易维护，遵循DRY原则

### 2025年11月3日更新

#### 1. 工作表名称映射功能增强
- **功能**: 实现工作表名称标准化映射，统一处理历史文件中的不同命名
- **映射规则**:
  - `14年6月精加工` → `精加工`
  - `14年6月装配 喷漆` → `装配喷漆`
  - `14年6月绕嵌排` → `绕嵌排`
  - `装配 喷漆` → `装配喷漆`
  - `喷漆装配` → `装配喷漆`
  - `金加工` → `精加工`
- **结果**: 历史文件中的工作表名称自动标准化，便于数据统一管理

#### 2. 特殊逻辑架构重构
- **功能**: 重构特殊逻辑处理函数返回值和数据流
- **结果**: 映射后的工作表名称正确存储到数据库，解决映射不生效的问题

#### 3. 前装/中装/后装人员处理增强
- **功能**: 扩展特殊逻辑处理范围，支持"前装人员"、"中装人员"、"后装人员"
- **结果**: 现在同时处理"前装"和"前装人员"、"中装"和"中装人员"、"后装"和"后装人员"

### 2025年10月30日更新

#### 1. 小数转换错误修复
- **问题**: `decimal.ConversionSyntax` 错误，处理202507.xls文件时出现无效计件数量值 '1*2'
- **解决方案**: 增强特殊逻辑预处理，使用 `pd.to_numeric()` 和 `errors='coerce'` 进行安全转换
- **结果**: 无效数值自动替换为默认值0，处理继续正常进行

#### 2. 日期列类型转换优化
- **问题**: 日期列值存储为带小数点的格式（如"2.0", "3.0"）
- **解决方案**: 增强数据类型转换逻辑，移除整数日期值的'.0'后缀
- **结果**: 日期列正确显示为整数格式（如"2", "3"）

#### 3. 增强日志记录功能
- **问题**: 无效计件数量日志缺少上下文信息
- **解决方案**: 在日志中增加定额和金额值信息
- **结果**: 日志格式从 `无效的计件数量值 '1*2' 在行 65，使用默认值0` 改进为 `无效的计件数量值 '1*2' 在行 65，使用默认值0, (定额 的值是：11, 金额的值是：2222)`

### 2025年10月26日更新

#### 1. 特殊逻辑日志优化
- **问题**: 特殊逻辑日志文件过大，包含过多重复条目
- **解决方案**: 从记录每个单独操作改为记录汇总信息
- **结果**: 日志文件从数百行减少到6行，显示汇总信息如："将'前装'记录拆分为2行: 黄志梅 和 陈会清 共119次"

#### 2. 数据类型优化
- **问题**: "计件数量"字段应为浮点数，但数据库存储为整数
- **解决方案**: 将数据库中的"计件数量"字段从INT改为FLOAT
- **结果**: "计件数量"正确存储为浮点数（如20.0, 10.0, 1.0等）

## 待定问题

- **工序编号** - 工序编号信息
- **乘系数定额** - 乘以系数后的定额金额
- **乘系数合计金额** - 乘以系数后的合计金额

这些列目前不在预期的列结构范围内，因此在数据处理过程中会被自动过滤掉。如果需要处理这些列，可以考虑：

1. 扩展数据库架构以包含这些字段
2. 添加相应的特殊逻辑规则来处理这些列
3. 更新`expected_columns`配置以包含这些字段

## 许可证

本项目仅供内部使用。

## 技术支持

如有问题，请联系开发团队。
